name: Cymbl Test CI

on: [push]

jobs:
  build:
    name: Build ${{ matrix.build }} ${{ matrix.os }} ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        build: ["Release"] #, "Debug"] # "RelWithDebInfo"
        os: [ubuntu-18.04]

    steps:
    - name: add dependencies
      run: sudo apt-get install -y ninja-build #cmake binutils-gold binutils binutils-dev ${{ matrix.compiler }} ${{ matrix.linker-pkg }}
    - name: setup cymbl
      run: |
          cd /
          sudo wget --no-verbose https://cymbl-installer.s3.amazonaws.com/LLVM-14.0.5-Linux.sh
          printf "y\nn\n" | sudo bash LLVM-14.0.5-Linux.sh
          printf "{\"refreshToken\": \"%s\", \"authURL\": \"https://i923u4ynde.execute-api.us-east-1.amazonaws.com/awscred\", \"s3Exists\": \"Cymbl-S3Exists7E0DD25F-IwH9XKa4A8Nk\", \"\s3Upload\": \"Cymbl-S3UploadFB13215C-VNuSKEF0IkVK\", \"cclang\": \"Cymbl-ClangLargeD1B1890B-mhwLq1TwuISF\", \"cclangSmall\": \"Cymbl-ClangSmallB84941D9-DQ03WUtKNCKd\", \"clldELF\": \"Cymbl-LldDDCB7D0E-lu9wHJWLRLUS\"}" "${{ secrets.CYMBLCONFIG }}" > ~/.cymblconfig
    - uses: actions/checkout@v2
      with:
        fetch-depth: 1
        path: src

    - name: mkdir
      run: mkdir build
    - name: cmake
      run: |
        cd build
        CYMBL=OFF cmake ../src/llvm -GNinja -DCMAKE_BUILD_TYPE=${{ matrix.build }} -DCMAKE_C_COMPILER=/bin/clang -DCMAKE_CXX_COMPILER=/bin/clang++ -DCMAKE_ASM_COMPILER=/bin/clang
    - name: build
      run: |
        cd build
        cymbld & disown
        sleep 10
        ninja -j1003
